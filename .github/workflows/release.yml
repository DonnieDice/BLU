name: Package and Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'           # v1.2.3
      - 'v[0-9]+.[0-9]+.[0-9]+-beta*'      # v1.2.3-beta.1
      - 'v[0-9]+.[0-9]+.[0-9]+-alpha*'     # v1.2.3-alpha.1
    branches:
      - alpha
      - dev

env:
  CF_API_KEY: ${{ secrets.CF_API_KEY }}
  WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}
  WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
  GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}  # üîê Store securely!

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: üõ†Ô∏è Clone Project
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üßë‚Äçüîß Configure Git User
        run: |
          git config --global user.name "donniedice"
          git config --global user.email "donniedice@protonmail.com"

      - name: üß≠ Determine Release Type
        id: release_type
        run: |
          case "${{ github.ref }}" in
            refs/tags/*)
              if [[ "${{ github.ref }}" == *"beta"* ]]; then
                echo "type=beta" >> $GITHUB_OUTPUT
              elif [[ "${{ github.ref }}" == *"alpha"* ]]; then
                echo "type=alpha" >> $GITHUB_OUTPUT
              else
                echo "type=release" >> $GITHUB_OUTPUT
              fi
              ;;
            refs/heads/dev)
              echo "type=dev" >> $GITHUB_OUTPUT
              ;;
            refs/heads/alpha)
              echo "type=alpha-branch" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "type=unknown" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: üì¶ Extract Version from TOC
        id: version
        run: |
          version=$(grep -oP '^## Version: \K(.*)' BLU.toc)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" >> $GITHUB_OUTPUT

      - name: üìù Extract Changelog
        id: changelog
        run: |
          if [[ -f "docs/CHANGES.md" ]]; then
            jq -Rs '.' < docs/CHANGES.md >> $GITHUB_OUTPUT
            echo "changelog=$(jq -Rs '.' < docs/CHANGES.md)" >> $GITHUB_OUTPUT
          else
            echo "changelog=\"No changelog available\"" >> $GITHUB_OUTPUT
          fi

      - name: üì¶ Package and Release
        uses: BigWigsMods/packager@master

      - name: üì¢ Send Discord Notification
        if: success()
        run: |
          case "${{ steps.release_type.outputs.type }}" in
            "release")
              title="üéâ BLU | Better Level-Up! - ${{ steps.version.outputs.version }}"
              desc="**Play sounds from other games!** A new version of BLU has been released!\n\nüéµ **What's New:**\n$(echo '${{ steps.changelog.outputs.changelog }}' | jq -r .)"
              color=9830721
              footer="RGX Mods - RealmGX Community"
              fields=$(jq -n '[
                {
                  "name": "üì• Downloads",
                  "value": "[CurseForge](https://www.curseforge.com/wow/addons/blu)\n[Wago.io](https://addons.wago.io/addons/vEGPgWK1)\n[GitHub](https://github.com/DonnieDice/BLU)",
                  "inline": true
                },
                {
                  "name": "üéÆ Compatibility",
                  "value": "‚úÖ The War Within",
                  "inline": true
                },
                {
                  "name": "üí¨ Support",
                  "value": "[Report Issues](https://github.com/DonnieDice/BLU/issues)\n[Buy Me Coffee](https://www.buymeacoffee.com/donniedice)",
                  "inline": true
                }
              ]')
              ;;
            "beta")
              title="üß™ BLU Beta - ${{ steps.version.outputs.version }}"
              desc="A beta version of Better Level-Up! is available for testing!\n\n**What's New:**\n$(echo '${{ steps.changelog.outputs.changelog }}' | jq -r .)"
              color=16744448
              footer="RGX Mods - Beta Build"
              fields=$(jq -n '[{"name":"üì• Download Beta","value":"[CurseForge](https://www.curseforge.com/wow/addons/blu)\n[GitHub](https://github.com/DonnieDice/BLU/releases)"}]')
              ;;
            "dev")
              title="üõ†Ô∏è BLU Dev Build - ${{ steps.version.outputs.version }}"
              desc="A new development build has been pushed to the \`dev\` branch.\n\n**What's New:**\n$(echo '${{ steps.changelog.outputs.changelog }}' | jq -r .)"
              color=3447003
              footer="RGX Mods - Development Build"
              fields=$(jq -n '[{"name":"‚ö†Ô∏è Important","value":"This is not a stable release. Use only for testing purposes."}]')
              ;;
            "alpha-branch")
              title="üî¨ BLU Alpha - ${{ steps.version.outputs.version }}"
              desc="Development build for testing\n\n**What's New:**\n$(echo '${{ steps.changelog.outputs.changelog }}' | jq -r .)"
              color=16711680
              footer="RGX Mods - Alpha Build"
              fields="null"
              ;;
            *)
              title="‚ö†Ô∏è Unknown Build"
              desc="An unknown workflow run occurred."
              color=10000000
              footer="RGX Mods - Unknown"
              fields="null"
              ;;
          esac

          jq -n \
            --arg username "BLU Notification" \
            --arg avatar "https://raw.githubusercontent.com/DonnieDice/BLU/main/images/logo.png" \
            --arg title "$title" \
            --arg desc "$desc" \
            --argjson color "$color" \
            --arg footer "$footer" \
            --arg icon "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif" \
            --arg timestamp "${{ steps.version.outputs.timestamp }}" \
            --argjson fields "$fields" \
            '{
              username: $username,
              avatar_url: $avatar,
              embeds: [{
                title: $title,
                description: $desc,
                color: $color,
                footer: { text: $footer, icon_url: $icon },
                timestamp: $timestamp
              } | if $fields != null then .fields = $fields else . end]
            }' > payload.json

          curl -H "Content-Type: application/json" -X POST -d @payload.json $DISCORD_WEBHOOK

      - name: ‚ùå Send Failure Notification
        if: failure()
        run: |
          jq -n \
            --arg version "${{ steps.version.outputs.version || 'Unknown' }}"
            --arg run_id "${{ github.run_id }}"
            --arg timestamp "${{ steps.version.outputs.timestamp }}"
            '{
              username: "BLU Build Failed",
              avatar_url: "https://raw.githubusercontent.com/DonnieDice/BLU/main/images/logo.png",
              embeds: [{
                title: "‚ùå BLU Build Failed",
                description: "The release workflow encountered an error",
                url: "https://github.com/DonnieDice/BLU/actions/runs/\($run_id)",
                color: 15158332,
                fields: [
                  { "name": "Version", "value": $version, "inline": true },
                  { "name": "Workflow", "value": "[View Logs](https://github.com/DonnieDice/BLU/actions/runs/\($run_id))", "inline": true }
                ],
                footer: {
                  "text": "RGX Mods - Build System",
                  "icon_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif"
                },
                timestamp: $timestamp
              }]
            }' > payload.json
          curl -H "Content-Type: application/json" -X POST -d @payload.json $DISCORD_WEBHOOK