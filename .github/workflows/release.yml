name: Package and Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'           # v1.2.3
      - 'v[0-9]+.[0-9]+.[0-9]+-beta*'      # v1.2.3-beta.1
      - 'v[0-9]+.[0-9]+.[0-9]+-alpha*'     # v1.2.3-alpha.1
    branches:
      - alpha
      - dev

env:
  CF_API_KEY: ${{ secrets.CF_API_KEY }}
  WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}
  WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
  GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}  # üîê Store securely!

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: üõ†Ô∏è Clone Project
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üß∞ Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: üßë‚Äçüîß Configure Git User
        run: |
          git config --global user.name "donniedice"
          git config --global user.email "donniedice@protonmail.com"

      - name: üß≠ Determine Release Type
        id: release_type
        run: |
          case "${{ github.ref }}" in
            refs/tags/*)
              if [[ "${{ github.ref }}" == *"beta"* ]]; then
                echo "type=beta" >> $GITHUB_OUTPUT
              elif [[ "${{ github.ref }}" == *"alpha"* ]]; then
                echo "type=alpha" >> $GITHUB_OUTPUT
              else
                echo "type=release" >> $GITHUB_OUTPUT
              fi
              ;;
            refs/heads/dev)
              echo "type=dev" >> $GITHUB_OUTPUT
              ;;
            refs/heads/alpha)
              echo "type=alpha-branch" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "type=unknown" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: üì¶ Extract Version from TOC
        id: version
        run: |
          version=$(grep -oP '^## Version: \K(.*)' BLU.toc)
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" >> $GITHUB_OUTPUT

      - name: üìù Extract Changelog
        id: changelog
        run: |
          if [[ -f "docs/CHANGES.md" ]]; then
            changelog=$(jq -Rs '.' < docs/CHANGES.md)
            echo "changelog=${changelog}" >> $GITHUB_OUTPUT
          else
            echo "changelog=\"No changelog available\"" >> $GITHUB_OUTPUT
          fi

      - name: üì¶ Package and Release
        uses: BigWigsMods/packager@master

      - name: üöÄ Upload to Wago.io
        uses: BigWigsMods/wago-upload@v2
        with:
          wago-token: ${{ secrets.WAGO_API_TOKEN }}
          project-id: "vEGPgWK1"
          version: ${{ steps.version.outputs.version }}
          changelog: ${{ steps.changelog.outputs.changelog }}
          game-version: "11.0.5"

      - name: üöÄ Upload to WoWInterface
        uses: BigWigsMods/wowinterface-upload@v2
        with:
          wow-token: ${{ secrets.WOWI_API_TOKEN }}
          addon-id: "26465"
          version: ${{ steps.version.outputs.version }}
          changelog: ${{ steps.changelog.outputs.changelog }}
          game-version: "11.0.5"

      - name: üì¢ Send Discord Notification
        if: success()
        run: |
          # Read changelog content
          if [[ -f "docs/CHANGES.md" ]]; then
            changelog_content=$(cat docs/CHANGES.md)
          else
            changelog_content="No changelog available"
          fi
          
          # Determine release type and set variables
          case "${{ steps.release_type.outputs.type }}" in
            "release")
              title="üéâ BLU | Better Level-Up! - ${{ steps.version.outputs.version }}"
              color=9830721
              footer="RGX Mods - RealmGX Community"
              fields='[
                {
                  "name": "üì• Downloads",
                  "value": "[CurseForge](https://www.curseforge.com/wow/addons/blu)\n[Wago.io](https://addons.wago.io/addons/vEGPgWK1)\n[GitHub](https://github.com/DonnieDice/BLU)",
                  "inline": true
                },
                {
                  "name": "üéÆ Compatibility",
                  "value": "‚úÖ The War Within",
                  "inline": true
                },
                {
                  "name": "üí¨ Support",
                  "value": "[Report Issues](https://github.com/DonnieDice/BLU/issues)\n[Buy Me Coffee](https://www.buymeacoffee.com/donniedice)",
                  "inline": true
                }
              ]'
              ;;
            "beta")
              title="üß™ BLU Beta - ${{ steps.version.outputs.version }}"
              color=16744448
              footer="RGX Mods - Beta Build"
              fields='[{"name":"üì• Download Beta","value":"[CurseForge](https://www.curseforge.com/wow/addons/blu)\n[GitHub](https://github.com/DonnieDice/BLU/releases)"}]'
              ;;
            "dev")
              title="üõ†Ô∏è BLU Dev Build - ${{ steps.version.outputs.version }}"
              color=3447003
              footer="RGX Mods - Development Build"
              fields='[{"name":"‚ö†Ô∏è Important","value":"This is not a stable release. Use only for testing purposes."}]'
              ;;
            "alpha-branch")
              title="üî¨ BLU Alpha - ${{ steps.version.outputs.version }}"
              color=16711680
              footer="RGX Mods - Alpha Build"
              fields='null'
              ;;
            *)
              title="‚ö†Ô∏è Unknown Build"
              color=10000000
              footer="RGX Mods - Unknown"
              fields='null'
              ;;
          esac
          
          # Create description with changelog
          desc="**Play sounds from other games!** A new version of BLU has been released!\n\nüéµ **What's New:**\n${changelog_content}"
          
          # Adjust description based on release type
          case "${{ steps.release_type.outputs.type }}" in
            "beta")
              desc="A beta version of Better Level-Up! is available for testing!\n\n**What's New:**\n${changelog_content}"
              ;;
            "dev")
              desc="A new development build has been pushed to the \`dev\` branch.\n\n**What's New:**\n${changelog_content}"
              ;;
            "alpha-branch")
              desc="Development build for testing\n\n**What's New:**\n${changelog_content}"
              ;;
            *)
              # Release description is already set
              ;;
          esac
          
          # Create JSON payload
          jq -n \
            --arg username "BLU Notification" \
            --arg avatar_url "https://raw.githubusercontent.com/DonnieDice/BLU/main/images/logo.png" \
            --arg title "$title" \
            --arg desc "$desc" \
            --argjson color "$color" \
            --arg footer "$footer" \
            --arg icon_url "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif" \
            --arg timestamp "${{ steps.version.outputs.timestamp }}" \
            --argjson fields "$fields" \
            '{
              username: $username,
              avatar_url: $avatar_url,
              embeds: [{
                title: $title,
                description: $desc,
                color: $color,
                footer: {
                  text: $footer,
                  icon_url: $icon_url
                },
                timestamp: $timestamp
              } | if $fields != null and $fields != "null" then .fields = $fields else . end]
            }' > payload.json
          
          # Send to Discord
          curl -H "Content-Type: application/json" -X POST -d @payload.json $DISCORD_WEBHOOK

      - name: ‚ùå Send Failure Notification
        if: failure()
        run: |
          jq -n \
            --arg version "${{ steps.version.outputs.version || 'Unknown' }}" \
            --arg run_id "${{ github.run_id }}" \
            --arg timestamp "${{ steps.version.outputs.timestamp }}" \
            '{
              username: "BLU Build Failed",
              avatar_url: "https://raw.githubusercontent.com/DonnieDice/BLU/main/images/logo.png",
              embeds: [{
                title: "‚ùå BLU Build Failed",
                description: "The release workflow encountered an error",
                url: "https://github.com/DonnieDice/BLU/actions/runs/\($run_id)",
                color: 15158332,
                fields: [
                  { "name": "Version", "value": $version, "inline": true },
                  { "name": "Workflow", "value": "[View Logs](https://github.com/DonnieDice/BLU/actions/runs/\($run_id))", "inline": true }
                ],
                footer: {
                  "text": "RGX Mods - Build System",
                  "icon_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif"
                },
                timestamp: $timestamp
              }]
            }' > payload.json
          curl -H "Content-Type: application/json" -X POST -d @payload.json $DISCORD_WEBHOOK