name: Package and Release
on:
  push:
    tags:
      - 'v*'
      - '*'
    branches:
      - alpha
      - main
      - master
env:
  CF_API_KEY: ${{ secrets.CF_API_KEY }}
  WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}
  WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
  GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Clone Project
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configure Git user
        run: |
          git config --global user.name "donniedice"
          git config --global user.email "donniedice@protonmail.com"
      - name: Determine Release Type
        id: set_release_type
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME="${{ github.ref_name }}"
            if [[ "$TAG_NAME" == *"beta"* ]]; then
              echo "release_type=beta" >> $GITHUB_OUTPUT
            elif [[ "$TAG_NAME" == *"alpha"* ]]; then
              echo "release_type=alpha" >> $GITHUB_OUTPUT
            else
              echo "release_type=release" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.ref }}" == "refs/heads/alpha" ]]; then
            echo "release_type=alpha" >> $GITHUB_OUTPUT
          else
            echo "release_type=none" >> $GITHUB_OUTPUT
          fi
          echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
      - name: Extract Version from TOC
        id: extract_version
        run: |
          if [ -f "BLU.toc" ]; then
            version=$(grep -oP '^## Version: \K(.*)' BLU.toc || echo "unknown")
          else
            version="${{ github.ref_name }}"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" >> $GITHUB_OUTPUT
      - name: Extract Changelog
        id: extract_changelog
        run: |
          if [ -f "docs/CHANGES.md" ]; then
            # Read changelog, escape for JSON, preserve actual newlines
            CHANGELOG=$(cat docs/CHANGES.md | head -50 | jq -Rs '.')
            # Remove surrounding quotes that jq adds
            CHANGELOG=${CHANGELOG:1:-1}
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "changelog=Check the commit history for changes" >> $GITHUB_OUTPUT
          fi
      - name: Package Addon
        uses: BigWigsMods/packager@master
        with:
          pandoc: true
        if: steps.set_release_type.outputs.release_type != 'none'
      - name: Send Discord Release Notification
        if: success() && steps.set_release_type.outputs.release_type == 'release'
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          VERSION: ${{ steps.extract_version.outputs.version }}
          TAG_NAME: ${{ steps.set_release_type.outputs.tag_name }}
          TIMESTAMP: ${{ steps.extract_version.outputs.timestamp }}
          CHANGELOG: ${{ steps.extract_changelog.outputs.changelog }}
        with:
          script: |
            const https = require('https');
            
            // Get changelog and properly escape it for JSON
            let changelog = process.env.CHANGELOG || 'Check the commit history for changes';
            // Replace literal \n with actual newlines for Discord
            changelog = changelog.replace(/\\n/g, '\n');
            
            const payload = {
              "username": "BLU Update",
              "avatar_url": "https://raw.githubusercontent.com/DonnieDice/BLU/main/images/logo.png",
              "embeds": [{
                "title": `ðŸŽ‰ BLU | Better Level-Up! - ${process.env.VERSION}`,
                "description": `**Play sounds from other games!** A new version of BLU has been released!\n\nðŸŽµ **What's New:**\n${changelog}`,
                "url": `https://github.com/DonnieDice/BLU/releases/tag/${process.env.TAG_NAME}`,
                "color": 9830721,
                "thumbnail": {
                  "url": "https://raw.githubusercontent.com/DonnieDice/BLU/main/images/logo.png"
                },
                "fields": [
                  {
                    "name": "ðŸ“¥ Downloads",
                    "value": "[CurseForge](https://www.curseforge.com/wow/addons/blu)\n[Wago.io](https://addons.wago.io/addons/vEGPgWK1)\n[GitHub](https://github.com/DonnieDice/BLU)",
                    "inline": true
                  },
                  {
                    "name": "ðŸŽ® Compatibility",
                    "value": "âœ… The War Within\nâœ… Cataclysm Classic\nâœ… Classic Era\nâœ… MoP Remix",
                    "inline": true
                  },
                  {
                    "name": "ðŸ’¬ Support",
                    "value": "[Report Issues](https://github.com/DonnieDice/BLU/issues)\n[Buy Me Coffee](https://www.buymeacoffee.com/donniedice)",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "RGX Mods - RealmGX Community",
                  "icon_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif"
                },
                "timestamp": process.env.TIMESTAMP
              }]
            };
            
            const webhookUrl = new URL(process.env.DISCORD_WEBHOOK);
            const postData = JSON.stringify(payload);
            
            const options = {
              hostname: webhookUrl.hostname,
              path: webhookUrl.pathname + webhookUrl.search,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
              }
            };
            
            const req = https.request(options, (res) => {
              console.log(`Discord notification sent. Status: ${res.statusCode}`);
            });
            
            req.on('error', (error) => {
              console.error('Discord notification failed:', error);
            });
            
            req.write(postData);
            req.end();
      - name: Send Discord Beta Notification
        if: success() && steps.set_release_type.outputs.release_type == 'beta'
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          VERSION: ${{ steps.extract_version.outputs.version }}
          TIMESTAMP: ${{ steps.extract_version.outputs.timestamp }}
          CHANGELOG: ${{ steps.extract_changelog.outputs.changelog }}
        with:
          script: |
            const https = require('https');
            
            let changelog = process.env.CHANGELOG || 'Check the commit history for changes';
            changelog = changelog.replace(/\\n/g, '\n');
            
            const payload = {
              "username": "BLU Beta",
              "avatar_url": "https://raw.githubusercontent.com/DonnieDice/BLU/main/images/logo.png",
              "embeds": [{
                "title": `ðŸ§ª BLU Beta - ${process.env.VERSION}`,
                "description": `A beta version of Better Level-Up! is available for testing!\n\n**What's New:**\n${changelog}`,
                "color": 16744448,
                "fields": [
                  {
                    "name": "ðŸ“¥ Download Beta",
                    "value": "[CurseForge](https://www.curseforge.com/wow/addons/blu)\n[GitHub](https://github.com/DonnieDice/BLU/releases)"
                  }
                ],
                "footer": {
                  "text": "RGX Mods - Beta Build",
                  "icon_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif"
                },
                "timestamp": process.env.TIMESTAMP
              }]
            };
            
            const webhookUrl = new URL(process.env.DISCORD_WEBHOOK);
            const postData = JSON.stringify(payload);
            
            const options = {
              hostname: webhookUrl.hostname,
              path: webhookUrl.pathname + webhookUrl.search,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
              }
            };
            
            const req = https.request(options, (res) => {
              console.log(`Discord notification sent. Status: ${res.statusCode}`);
            });
            
            req.on('error', (error) => {
              console.error('Discord notification failed:', error);
            });
            
            req.write(postData);
            req.end();
      - name: Send Discord Alpha Notification
        if: success() && steps.set_release_type.outputs.release_type == 'alpha'
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          VERSION: ${{ steps.extract_version.outputs.version }}
          TIMESTAMP: ${{ steps.extract_version.outputs.timestamp }}
          CHANGELOG: ${{ steps.extract_changelog.outputs.changelog }}
        with:
          script: |
            const https = require('https');
            
            let changelog = process.env.CHANGELOG || 'Check the commit history for changes';
            changelog = changelog.replace(/\\n/g, '\n');
            
            const payload = {
              "username": "BLU Alpha",
              "avatar_url": "https://raw.githubusercontent.com/DonnieDice/BLU/main/images/logo.png",
              "embeds": [{
                "title": `ðŸ”¬ BLU Alpha - ${process.env.VERSION}`,
                "description": `Development build for testing\n\n**What's New:**\n${changelog}`,
                "color": 16711680,
                "footer": {
                  "text": "RGX Mods - Alpha Build",
                  "icon_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif"
                },
                "timestamp": process.env.TIMESTAMP
              }]
            };
            
            const webhookUrl = new URL(process.env.DISCORD_WEBHOOK);
            const postData = JSON.stringify(payload);
            
            const options = {
              hostname: webhookUrl.hostname,
              path: webhookUrl.pathname + webhookUrl.search,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
              }
            };
            
            const req = https.request(options, (res) => {
              console.log(`Discord notification sent. Status: ${res.statusCode}`);
            });
            
            req.on('error', (error) => {
              console.error('Discord notification failed:', error);
            });
            
            req.write(postData);
            req.end();
      - name: Send Discord Failure Notification
        if: failure()
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          VERSION: ${{ steps.extract_version.outputs.version }}
          TIMESTAMP: ${{ steps.extract_version.outputs.timestamp }}
          RUN_ID: ${{ github.run_id }}
        with:
          script: |
            const https = require('https');
            
            const payload = {
              "username": "BLU Build Failed",
              "avatar_url": "https://raw.githubusercontent.com/DonnieDice/BLU/main/images/logo.png",
              "embeds": [{
                "title": "âŒ BLU Build Failed",
                "description": "The release workflow encountered an error",
                "url": `https://github.com/DonnieDice/BLU/actions/runs/${process.env.RUN_ID}`,
                "color": 15158332,
                "fields": [
                  {
                    "name": "Version",
                    "value": process.env.VERSION || 'Unknown',
                    "inline": true
                  },
                  {
                    "name": "Workflow",
                    "value": `[View Logs](https://github.com/DonnieDice/BLU/actions/runs/${process.env.RUN_ID})`,
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "RGX Mods - Build System",
                  "icon_url": "https://raw.githubusercontent.com/donniedice/SimpleQuestPlates/main/images/kiwi.gif"
                },
                "timestamp": process.env.TIMESTAMP
              }]
            };
            
            const webhookUrl = new URL(process.env.DISCORD_WEBHOOK);
            const postData = JSON.stringify(payload);
            
            const options = {
              hostname: webhookUrl.hostname,
              path: webhookUrl.pathname + webhookUrl.search,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(postData)
              }
            };
            
            const req = https.request(options, (res) => {
              console.log(`Discord notification sent. Status: ${res.statusCode}`);
            });
            
            req.on('error', (error) => {
              console.error('Discord notification failed:', error);
            });
            
            req.write(postData);
            req.end();